---
layout: post
status: publish
published: true
title: Capistrano Deploy with Git and Passenger
author:
  display_name: Geoff Lane
  login: admin
  email: geoff@zorched.net
  url: http://www.zorched.net
author_login: admin
author_email: geoff@zorched.net
author_url: http://www.zorched.net
wordpress_id: 113
wordpress_url: http://www.zorched.net/?p=113
date: '2008-06-17 10:47:15 -0400'
date_gmt: '2008-06-17 16:47:15 -0400'
categories:
- Ruby
tags:
- ruby-on-rails
- git
- mod_rails
- capistrano
comments:
- id: 13216
  author: Sean Lerner
  author_email: sean@theworkinggroup.ca
  author_url: http://theworkinggroup.ca
  date: '2008-06-18 13:03:23 -0400'
  date_gmt: '2008-06-18 19:03:23 -0400'
  content: Thanks, this was useful to me.
- id: 13224
  author: Capistrano and Ferret DRB
  author_email: ''
  author_url: http://www.zorched.net/2008/06/19/capistrano-and-ferret-drb/
  date: '2008-06-19 10:27:09 -0400'
  date_gmt: '2008-06-19 16:27:09 -0400'
  content: "[...] is a bit of a followup to my previous post on Capistrano with Git
    and Passenger. I decided to use Ferret via the acts_as_ferret (AAF) plugin. Ferret
    is a full-text search inspired [...]"
- id: 13487
  author: Matt Darby
  author_email: matt@matt-darby.com
  author_url: http://blog.matt-darby.com
  date: '2008-07-24 18:21:47 -0400'
  date_gmt: '2008-07-25 00:21:47 -0400'
  content: Good stuff!
- id: 14380
  author: get with git and important list of links to help you get started | Ryan
    Smith
  author_email: ''
  author_url: http://ryan-smith.org/2008/get-with-git/
  date: '2008-12-21 18:25:15 -0500'
  date_gmt: '2008-12-22 00:25:15 -0500'
  content: "[...] capistrano &amp; Git [...]"
- id: 14728
  author: Christoph
  author_email: info@christophbuente.de
  author_url: http://www.kimbo.me
  date: '2009-01-26 01:40:33 -0500'
  date_gmt: '2009-01-26 07:40:33 -0500'
  content: Thanks a lot, this made deploying with passenger and capistrano work like
    a charme.
- id: 14951
  author: PabloC
  author_email: pablocorral@gmail.com
  author_url: http://www.pablocorral.com.ar
  date: '2009-02-20 19:31:12 -0500'
  date_gmt: '2009-02-21 01:31:12 -0500'
  content: thanks!!
- id: 15071
  author: PEZ
  author_email: pez@pezius.com
  author_url: http://www.bagonca.com/blog/author/pez/
  date: '2009-05-01 06:27:44 -0400'
  date_gmt: '2009-05-01 12:27:44 -0400'
  content: Thanks a lot! I'll try this out right now and will get back with more comments
    about how I fared. Keep up the sharing!
- id: 15100
  author: Trey
  author_email: marion.newman@gmail.com
  author_url: http://exsellint.crm
  date: '2009-05-24 22:02:48 -0400'
  date_gmt: '2009-05-25 04:02:48 -0400'
  content: 'Nice write up! However, I was wondering if the setup was the same if you
    have multiple repositories you are deploying. I have multiple repos and am able
    to deploy to one of them with no problem, however I am getting a "repository not
    found" when trying to deploy to another. In the error, the repo name it is trying
    to access is correct and I am able to push changes with no problem ( I see the
    commit in github). Any ideas regarding why I may be seeing this? Here is the error
    message, any help would be greatly appreciated! * executing `deploy:update'' **
    transaction: start * executing `deploy:update_code'' updating the cached checkout
    on all servers executing locally: "git ls-remote git@github.com:sfolks&#47;exsellintcrm.git
    master" * executing "if [ -d &#47;home&#47;neo&#47;apps&#47;exsellintcrm&#47;shared&#47;cached-copy
    ]; then cd &#47;home&#47;neo&#47;apps&#47;exsellintcrm&#47;shared&#47;cached-copy
    &amp;&amp; git fetch -q origin &amp;&amp; git reset -q --hard 69335a40b5f37071f6fa2436b587a48fae4629c6;
    else git clone -q git@github.com:sfolks&#47;exsellintcrm.git &#47;home&#47;neo&#47;apps&#47;exsellintcrm&#47;shared&#47;cached-copy
    &amp;&amp; cd &#47;home&#47;neo&#47;apps&#47;exsellintcrm&#47;shared&#47;cached-copy
    &amp;&amp; git checkout -q -b deploy 69335a40b5f37071f6fa2436b587a48fae4629c6;
    fi" servers: ["exsellintcrm.com"] Password: [exsellintcrm.com] executing command
    ** [exsellintcrm.com :: out] Repository not found. If you''ve just created it,
    please try again in a few seconds. ** [exsellintcrm.com :: out] fatal: The remote
    end hung up unexpectedly command finished *** [deploy:update_code] rolling back
    * executing "rm -rf &#47;home&#47;neo&#47;apps&#47;exsellintcrm&#47;releases&#47;20090525030837;
    true" servers: ["exsellintcrm.com"] [exsellintcrm.com] executing command command
    finished failed: "sh -c \"if [ -d &#47;home&#47;neo&#47;apps&#47;exsellintcrm&#47;shared&#47;cached-copy
    ]; then cd &#47;home&#47;neo&#47;apps&#47;exsellintcrm&#47;shared&#47;cached-copy
    &amp;&amp; git fetch -q origin &amp;&amp; git reset -q --hard 69335a40b5f37071f6fa2436b587a48fae4629c6;
    else git clone -q git@github.com:sfolks&#47;exsellintcrm.git &#47;home&#47;neo&#47;apps&#47;exsellintcrm&#47;shared&#47;cached-copy
    &amp;&amp; cd &#47;home&#47;neo&#47;apps&#47;exsellintcrm&#47;shared&#47;cached-copy
    &amp;&amp; git checkout -q -b deploy 69335a40b5f37071f6fa2436b587a48fae4629c6;
    fi\"" on exsellintcrm.com'
- id: 15104
  author: Geoff Lane
  author_email: geoff@zorched.net
  author_url: http://www.zorched.net
  date: '2009-05-25 10:47:37 -0400'
  date_gmt: '2009-05-25 16:47:37 -0400'
  content: "@Trey, I've only ever tried it with one repository, so I'm not sure if
    it will work in a multiple repository model."
- id: 15558
  author: 'ConceptSpace: Rails Deployment; Capistrano, Passenger, NGINX'
  author_email: ''
  author_url: http://conceptspace.wikidot.com/blog:43
  date: '2009-07-19 16:28:09 -0400'
  date_gmt: '2009-07-19 22:28:09 -0400'
  content: "[...] the easiest deployment experience, I think, we should deploy using
    Capistrano with Git and Passenger. Of course, we should modify that recipe to
    use NGINX. While Apache uses half a gig of memory, [...]"
- id: 15593
  author: kenny's me2DAY
  author_email: ''
  author_url: http://me2day.net/kenny/2009/08/09#13:48:45
  date: '2009-08-08 22:49:09 -0400'
  date_gmt: '2009-08-09 04:49:09 -0400'
  content: "<strong>&igrave;&frac14;&euro;&euml;&lsaquo;&circ;&ecirc;&micro;&deg;&igrave;\x9D&tilde;
    &igrave;&fnof;\x9D&ecirc;&deg;\x81...<&#47;strong>\n\nOne of the great things
    about Rails and its community is that they are very lazy. &ecirc;&middot;&cedil;&euml;&lsaquo;&circ;&ecirc;&sup1;&OElig;,
    &ecirc;&deg;&oelig;&euml;&deg;&oelig;&igrave;Å¾\x90&euml;&Scaron;&rdquo; &ecirc;&sup2;&OElig;&igrave;\x9D&bdquo;&euml;&Yuml;&not;&igrave;&bull;&frac14;
    &iacute;&bull;&oelig;&euml;&lsaquo;&curren;&euml;&lsaquo;&circ;&ecirc;&sup1;&OElig;&igrave;&scaron;&rdquo;.
    &ecirc;&middot;&cedil;&ecirc;&sup2;&OElig; &igrave;&sect;&bdquo;&euml;&brvbar;&not;!..."
- id: 16253
  author: redconfetti
  author_email: jason@redconfetti.com
  author_url: http://www.redconfetti.com
  date: '2010-07-20 21:34:51 -0400'
  date_gmt: '2010-07-21 03:34:51 -0400'
  content: Thanks man. That really helped having an updated Capistrano recipe for
    Git&#47;Passenger. Another one I was using was giving me some error because it
    was trying to run script&#47;process&#47;reaper
- id: 16254
  author: Setting up Deployment for Rails using Capistrano, Apache with Passenger
    and Git | redconfetti
  author_email: ''
  author_url: http://www.redconfetti.com/2010/07/setting-up-deployment-for-rails-using-capistrano-apache-with-passenger-and-git/
  date: '2010-07-20 21:48:26 -0400'
  date_gmt: '2010-07-21 03:48:26 -0400'
  content: "[...] http:&#47;&#47;www.zorched.net&#47;2008&#47;06&#47;17&#47;capistrano-deploy-with-git-and-passenger&#47;
    [...]"
- id: 17907
  author: 'Capistrano Deploy with Git and Passenger: deploy.rb | &egrave;&iexcl;&mdash;&egrave;&sect;&rsquo;&aring;&rsquo;&ndash;&aring;&bull;&iexcl;&aring;&ordm;&mdash;'
  author_email: ''
  author_url: http://www.huqiushi.com/?p=658
  date: '2011-07-14 09:34:16 -0400'
  date_gmt: '2011-07-14 15:34:16 -0400'
  content: "[...] http:&#47;&#47;www.zorched.net&#47;2008&#47;06&#47;17&#47;capistrano-deploy-with-git-and-passenger&#47;
    [...]"
- id: 18238
  author: Ruby on Rails application deployment strategies | zzzzzzzzz
  author_email: ''
  author_url: http://www.zzzzzzzzz.net/?p=1104
  date: '2012-12-26 00:59:06 -0500'
  date_gmt: '2012-12-26 06:59:06 -0500'
  content: "[...] http:&#47;&#47;www.zorched.net&#47;2008&#47;06&#47;17&#47;capistrano-deploy-with-git-and-passenger&#47;
    \  This entry was posted in Uncategorized and tagged apache, capistrano, deployment,
    mod_rails, passenger, ruby, ruby on rails, webdev by zzz_zwp. Bookmark the permalink.
    [...]"
---
<p>One of the great things about Rails and its community is that they are very lazy. Lazy in the good way of not wanting to do boring, repetitive, error prone things manually. They metaprogram and they automate. A great example of this is <a href="http:&#47;&#47;www.capify.org">Capistrano<&#47;a>. Capistrano allows you to deploy Rails applications with ease. The normal scenario is baked into Capistrano as a deployment convention and then you can customize it if you need to.</p>
<h3>My Story<&#47;h3><br />
I've recently redeployed a couple of <a href="http:&#47;&#47;www.rubyonrails.org">Ruby on Rails<&#47;a> sites using <a href="http:&#47;&#47;www.modrails.com&#47;">Passenger (mod_rails)<&#47;a>. Passenger is an Apache module that really simplifies the deployment of small-scale Rails applications. Once Passenger is installed and your Rails application is set up as a virtual directory, it just works. Passenger auto-detects the fact that the directory is a Rails application and runs it for you. No need for a mongrel cluster or manually configuring load balancing.</p>
<p>I'm also using <a href="http:&#47;&#47;git.or.cz&#47;">Git<&#47;a> as my version control system on small, personal projects because it's easy to use and I can work on multiple laptops and commit locally and worry about pushing to a central location when I have a network connection.</p>
<p>Seeing those things, I wanted to make them all work with Capistrano so that I could continue being lazy. To do this, I'm using Capistrano v2.4. It has Git support built in that works (some previous versions had support for Git, but seemed to have a lot of trouble).</p>
<h3>Git Setup<&#47;h3><br />
By convention, Capistrano uses Subversion. So, I need to change my configuration to use git. The <strong>set :scm, :git<&#47;strong> does this. The repository information sets up where my git repository lives. In this case, I'm just using a bare git repository accessing it over SSH. You can also access your repository using the git and http protocols if you have that setup. The <strong>branch<&#47;strong> just says to deploy off of the master branch. </p>
<p>That's pretty much it - nice and easy.<br />
<code lang="ruby"><br />
set :scm, :git<br />
set :repository, "geoff@zorched.net:myapp.git"<br />
set :branch, "master"<br />
set :deploy_via, :remote_cache<br />
<&#47;code></p>
<h3>Passenger (mod_rails) Setup<&#47;h3><br />
The only thing that comes into play with Passenger is restarting the Rails application after a deployment is done. Passenger has an easy way to do this which is just to create a file called <strong>restart.txt<&#47;strong> in the Rails tmp directory. When it sees that, the Rails application process will be recycled automatically.</p>
<p>Doing this requires just a bit of Capistrano customization. We need to override the deploy:restart task and have it run a small shell script for us. In this case we are running <strong>run "touch #{current_path}&#47;tmp&#47;restart.txt"<&#47;strong> to accomplish this task.</p>
<p><code lang="ruby"><br />
namespace :deploy do<br />
  desc "Restarting mod_rails with restart.txt"<br />
  task :restart, :roles => :app, :except => { :no_release => true } do<br />
    run "touch #{current_path}&#47;tmp&#47;restart.txt"<br />
  end<br />
<&#47;code></p>
<p>We can also override the start and stop tasks because those don't really do anything in the mod_rails scenario like they would with mongrel or other deployments.<br />
<code lang="ruby"><br />
  [:start, :stop].each do |t|<br />
    desc "#{t} task is a no-op with mod_rails"<br />
    task t, :roles => :app do ; end<br />
  end<br />
end<br />
<&#47;code></p>
<h3>The Whole Thing<&#47;h3><br />
Putting everything together in my <strong>deploy.rb<&#47;strong> looks like the following:<br />
<code lang="ruby"><br />
set :application, "enotify"</p>
<p># If you aren't deploying to &#47;u&#47;apps&#47;#{application} on the target<br />
# servers (which is the default), you can specify the actual location<br />
# via the :deploy_to variable:<br />
set :deploy_to, "&#47;var&#47;www&#47;myapp"</p>
<p># If you aren't using Subversion to manage your source code, specify<br />
# your SCM below:<br />
set :scm, :git<br />
set :repository, "geoff@zorched.net:myapp.git"<br />
set :branch, "master"<br />
set :deploy_via, :remote_cache</p>
<p>set :user, 'geoff'<br />
set :ssh_options, { :forward_agent => true }</p>
<p>role :app, "zorched.net"<br />
role :web, "zorched.net"<br />
role :db,  "zorched.net", :primary => true</p>
<p>namespace :deploy do<br />
  desc "Restarting mod_rails with restart.txt"<br />
  task :restart, :roles => :app, :except => { :no_release => true } do<br />
    run "touch #{current_path}&#47;tmp&#47;restart.txt"<br />
  end</p>
<p>  [:start, :stop].each do |t|<br />
    desc "#{t} task is a no-op with mod_rails"<br />
    task t, :roles => :app do ; end<br />
  end<br />
end<br />
<&#47;code></p>
