---
layout: post
status: publish
published: true
title: Database Migrations for .NET
author:
  display_name: Geoff Lane
  login: admin
  email: geoff@zorched.net
  url: http://www.zorched.net
author_login: admin
author_email: geoff@zorched.net
author_url: http://www.zorched.net
wordpress_id: 102
wordpress_url: http://www.zorched.net/?p=102
date: '2008-04-20 15:31:58 -0400'
date_gmt: '2008-04-20 21:31:58 -0400'
categories:
- Code
- ".NET"
- Automation
tags:
- database
- Automation
- csharp
comments:
- id: 13878
  author: Spencer
  author_email: spencer.dillard@gmail.com
  author_url: ''
  date: '2008-08-22 03:13:12 -0400'
  date_gmt: '2008-08-22 09:13:12 -0400'
  content: "Question - does Migrator support timestamps in the table creation?  I
    wanted to use that to do dirty checks, but I'm not seeing an option anywhere.\r\nThanks
    in advance..."
- id: 13884
  author: Geoff Lane
  author_email: geoff@zorched.net
  author_url: http://www.zorched.net
  date: '2008-08-22 08:53:15 -0400'
  date_gmt: '2008-08-22 14:53:15 -0400'
  content: "Spencer,\r\nIt does not currently support automated timestamps or anything.
    You can of course create your own timestamp tables using the framework, but the
    framework won't do anything special with them."
- id: 14017
  author: Spencer
  author_email: spencer.dillard@gmail.com
  author_url: ''
  date: '2008-08-28 15:00:54 -0400'
  date_gmt: '2008-08-28 21:00:54 -0400'
  content: "Thanks.  I ended up creating an extension that is called in the AfterUp
    method.  It is SQL-specific, because that is what will be used for this system;
    I need to look into making it useful for the other supported systems and then
    proposing a patch.  In case anyone else wants to see it, here is the class that
    handles my stamp-like columns:\r\n<code lang=\"csharp\">\r\npublic static class
    MigrationHelper\r\n{\r\n    &#47;&#47;&#47; \r\n    &#47;&#47;&#47; This SQL Server-Specific
    method creates a Timestamp column.\r\n    &#47;&#47;&#47; \r\n    &#47;&#47;&#47;
    \r\n    &#47;&#47;&#47; \r\n     public static void AddConcurrencyChecking(ITransformationProvider
    database, string tableName)\r\n    {\r\n          string addTimestampQuery = \"ALTER
    TABLE \" + tableName + \" ADD timestamp TIMESTAMP NOT NULL;\";\r\n          IDbCommand
    cmd = database.GetCommand();\r\n          cmd.Connection.Open();\r\n          database.ExecuteNonQuery(addTimestampQuery);\r\n
    \         cmd.Connection.Close();         \r\n    }\r\n     public static void
    AddTimeStamps(ITransformationProvider database, string tableName)\r\n    {\r\n
    \           AddColumn(database, tableName, \"created_at\", DbType.DateTime);\r\n
    \           AddColumn(database, tableName, \"updated_at\", DbType.DateTime);\r\n
    \   }\r\n     public static void AddUserStamps(ITransformationProvider database,
    string tableName)\r\n    {\r\n          AddColumn(database, tableName, \"created_by\",
    DbType.Int32);\r\n          AddColumn(database, tableName, \"updated_by\", DbType.Int32);\r\n
    \   }\r\n     private static void AddColumn(ITransformationProvider database,
    string tableName, string columnName, DbType dbType)\r\n    {\r\n          database.AddColumn(tableName,
    new Migrator.Framework.Column(columnName,dbType));\r\n    }\r\n}\r\n<&#47;code>"
- id: 16040
  author: Terry
  author_email: terry@helpfulmove.com
  author_url: ''
  date: '2010-01-27 03:52:08 -0500'
  date_gmt: '2010-01-27 09:52:08 -0500'
  content: "Hello spencer, I am new to using Migrator.Framework please I would like
    you explain what you're trying to achieve from each method(AddConcurrencyChecking,
    AddTimeStamps, AddUserStamps and AddColumn). \r\n\r\nThanks for your time"
- id: 16292
  author: Onderweg Blog &raquo; Blog Archive &raquo; DynamicModel
  author_email: ''
  author_url: http://blog.onderweg.eu/2010/10/02/dynamicmodel/
  date: '2010-10-02 12:28:20 -0400'
  date_gmt: '2010-10-02 18:28:20 -0400'
  content: "[...] from Ruby on Rail migrations. A .NET tool that inspired me is migratordotnet;
    see this blog post: Database Migrations for .NET. The only major .NET ORM that
    also supports migrations (to my knowledge) is Lightspeed [...]"
---
<p>One of the more difficult things to manage in software projects is often changing a database schema over time. On the projects that I work on, we don't usually have DBAs who manage the schema so it is left up to the developers to figure out. The other thing you have to manage is applying changes to the database in such a way that you don't disrupt the work of other developers on your team. We need the change to go in at the same time as the code so that Continuous Integration can work.</p>
<h3>Migrations<&#47;h3><br />
While I don't know if they were invented there, migrations seem to have been popularized by Ruby on Rails. Rails is a database centric framework that implies the properties of your domain from the schema of your database. For that reason it makes sense that they came up with a very good way of These are some example migrations to give you an idea of the basics of creating a schema.</p>
<p><strong>001_AddAddressTable.cs<&#47;strong>:<br />
<code lang="csharp"><br />
using Migrator.Framework;<br />
using System.Data;<br />
[Migration(1)]<br />
public class AddAddressTable : Migration<br />
{<br />
    override public void Up()<br />
    {<br />
         Database.AddTable("Address",<br />
             new Column("id", DbType.Int32, ColumnProperty.PrimaryKey),<br />
             new Column("street", DbType.String, 50),<br />
             new Column("city", DbType.String, 50),<br />
             new Column("state", DbType.StringFixedLength, 2),<br />
             new Column("postal_code", DbType.String, 10)<br />
    }<br />
    override public void Down()<br />
    {<br />
        Database.RemoveTable("Address");<br />
    }<br />
}<br />
<&#47;code></p>
<p><strong>02_AddAddressColumns.cs<&#47;strong>:<br />
<code lang="csharp"><br />
using Migrator.Framework;<br />
using System.Data;<br />
[Migration(2)]<br />
public class AddAddressColumns : Migration<br />
{<br />
    public override void Up()<br />
    {<br />
        Database.AddColumn("Address", new Column("street2", DbType.String, 50));<br />
        Database.AddColumn("Address", new Column("street3", DbType.String, 50));<br />
    }<br />
    public override void Down()<br />
    {<br />
        Database.RemoveColumn("Address", "street2");<br />
        Database.RemoveColumn("Address", "street3");<br />
    }<br />
}<br />
<&#47;code></p>
<p><strong>003_AddPersonTable.cs<&#47;strong>:<br />
<code lang="csharp"><br />
using Migrator.Framework;<br />
using System.Data;<br />
[Migration(3)]<br />
public class AddPersonTable : Migration<br />
{<br />
    public override void Up()<br />
    {<br />
        Database.AddTable("Person",<br />
            new Column("id", DbType.Int32, ColumnProperty.PrimaryKey),<br />
            new Column("first_name", DbType.String, 50),<br />
            new Column("last_name", DbType.String, 50),<br />
            new Column("address_id", DbType.Int32, ColumnProperty.Unsigned)<br />
        );<br />
        Database.AddForeignKey("FK_PERSON_ADDRESS", "Person", "address_id", "Address", "id");<br />
    }<br />
    public override void Down()<br />
    {<br />
        Database.RemoveTable("Person");<br />
    }<br />
}<br />
<&#47;code></p>
<h3>Run Your Migrations<&#47;h3><br />
The best way to run your migrations will be to integrate it into your build automation tool of choice. If you are not using one, now is the time.</p>
<p>MigratorDotNet supports MSBuild and NAnt.</p>
<p><strong>MSBuild<&#47;strong>:<br />
<code lang="xml"><br />
<Target name="Migrate" DependsOnTargets="Build"><br />
    <CreateProperty Value="-1"  Condition="'$(SchemaVersion)'==''"><br />
        <Output TaskParameter="Value" PropertyName="SchemaVersion"&#47;><br />
    <&#47;CreateProperty><br />
    <Migrate Provider="SqlServer"<br />
            Connectionstring="Database=MyDB;Data Source=localhost;User Id=;Password=;"<br />
            Migrations="bin&#47;MyProject.dll"<br />
            To="$(SchemaVersion)"&#47;><br />
<&#47;Target><br />
<&#47;code></p>
<p><strong>NAnt<&#47;strong>:<br />
<code lang="xml"><br />
<target name="migrate" description="Migrate the database" depends="build"></p>
<property name="version" value="-1" overwrite="false" &#47;>
  <migrate<br />
    provider="MySql|PostgreSQL|SqlServer"<br />
    connectionstring="Database=MyDB;Data Source=localhost;User Id=;Password=;"<br />
    migrations="bin&#47;MyProject.dll"<br />
    to="${version}" &#47;><br />
<&#47;target><br />
<&#47;code></p>
<h3>So You Want to Migrate?<&#47;h3><br />
Some more documentation and example are available <a href="http:&#47;&#47;code.google.com&#47;p&#47;migratordotnet&#47;w&#47;list>on the wiki<&#47;a>.</p>
<p>The code can be downloaded at <a href="http:&#47;&#47;code.google.com&#47;p&#47;migratordotnet">MigratorDotNet<&#47;a>.  Some of the changes represented are still in an experimental branch that is in the process of being merged.</p>
<p><em><br />
MigratorDotNet is a continuation of code started by <a href="http:&#47;&#47;macournoyer.wordpress.com&#47;">Marc-Andr&Atilde;&copy; Cournoyer<&#47;a> and Nick Hemsley.<br />
<&#47;em></p>
